# Cache System for TruthLens Backend

## General Description

The cache system implemented in TruthLens Backend is designed to handle temporary files (mainly audio files generated by ElevenLabs) efficiently and robustly in production environments.

## Main Components

### 1. StorageService (`app/services/storage_service.py`)

**Features:**
- Absolute path handling to avoid production issues
- Automatic fallback to system temp directory if unable to write to main directory
- Specialized methods for saving audio files and metadata
- Automatic cleanup of old files

**Characteristics:**
- Uses absolute paths based on the service file location
- Automatically creates cache directory if it doesn't exist
- Verifies write permissions and uses fallback if necessary
- Integration with Supabase for data persistence

### 2. CacheManager (`app/services/cache_manager.py`)

**Features:**
- Scheduled automatic cleanup of old files
- Real-time cache statistics
- Manual control of cleanup scheduler
- Cache status monitoring

**Characteristics:**
- Asynchronous scheduler running in background
- Flexible cleanup interval configuration
- Robust error handling
- Detailed cache metrics

## Configuration

### Environment Variables

No additional environment variables required. The system uses:
- Current working directory as base
- Automatic fallback to system temp directory
- Existing Supabase configuration

### Directory Structure

```
TruthLens_backend/
├── app/
│   ├── data/
│   │   └── temp/          # Main cache directory
│   │       ├── voice_*.mp3    # Audio files
│   │       └── translation_*.json  # Metadata
│   └── services/
│       ├── storage_service.py
│       └── cache_manager.py
```

## Cache Management Endpoints

### 1. Cache Statistics
```http
GET /api/v1/translator/cache/stats
```

**Response:**
```json
{
  "status": "success",
  "data": {
    "file_count": 15,
    "total_size_bytes": 5242880,
    "total_size_mb": 5.0,
    "oldest_file": "voice_abc123.mp3",
    "newest_file": "voice_def456.mp3",
    "cache_directory": "/path/to/cache"
  }
}
```

### 2. Manual Cleanup
```http
POST /api/v1/translator/cache/cleanup?max_age_hours=24
```

**Response:**
```json
{
  "status": "success",
  "message": "Cache cleanup completed. Files older than 24 hours were removed."
}
```

### 3. Start Automatic Scheduler
```http
POST /api/v1/translator/cache/cleanup/start?cleanup_interval_hours=2
```

### 4. Stop Automatic Scheduler
```http
POST /api/v1/translator/cache/cleanup/stop
```

## Production Operation

### Automatic Initialization
- Cache manager initializes automatically when application starts
- Cleanup scheduler starts with 2-hour interval by default
- Static files are served from cache directory

### Error Handling
- Automatic fallback to system temp directory if permission issues
- Detailed logging of all operations
- Robust exception handling without interrupting service

### Automatic Cleanup
- Files older than 24 hours are automatically removed
- Cleanup runs every 2 hours in background
- Does not interfere with normal API operations

## Advantages of the New System

1. **Production Robustness**: Uses absolute paths and automatic fallbacks
2. **Automatic Management**: Automatic cleanup without manual intervention
3. **Monitoring**: Endpoints to verify cache status
4. **Scalability**: Efficient handling of temporary files
5. **Persistence**: Integration with Supabase for important data

## Migration from Previous System

### Main Changes:
1. Removal of problematic `TEMP_DIR` constant
2. Use of `StorageService` for all file operations
3. Implementation of automatic cleanup
4. Cache management endpoints

### Compatibility:
- Existing files are automatically migrated
- Audio URLs remain the same (`/static/voice_*.mp3`)
- No frontend changes required

## Monitoring and Maintenance

### Important Logs:
- `INFO: Cache cleanup scheduler started`
- `INFO: Audio file saved: /path/to/file.mp3`
- `INFO: Cleaned up X old files`

### Metrics to Monitor:
- Number of files in cache
- Total cache size
- Automatic cleanup frequency
- Read/write errors

### Troubleshooting:
1. **Permission errors**: System automatically uses system temp directory
2. **Files not found**: Verify that cleanup scheduler is not deleting files too quickly
3. **Disk space**: Monitor total cache size and adjust cleanup interval if necessary 